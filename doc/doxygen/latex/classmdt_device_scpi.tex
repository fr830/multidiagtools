\hypertarget{classmdt_device_scpi}{
\section{mdtDeviceScpi Class Reference}
\label{classmdt_device_scpi}\index{mdtDeviceScpi@{mdtDeviceScpi}}
}


Base class for SCPI based instruments.  




{\ttfamily \#include $<$mdtDeviceScpi.h$>$}



Inheritance diagram for mdtDeviceScpi:\nopagebreak
\begin{figure}[H]
\begin{center}
\leavevmode
\includegraphics[width=308pt]{classmdt_device_scpi__inherit__graph}
\end{center}
\end{figure}


Collaboration diagram for mdtDeviceScpi:
\nopagebreak
\begin{figure}[H]
\begin{center}
\leavevmode
\includegraphics[width=400pt]{classmdt_device_scpi__coll__graph}
\end{center}
\end{figure}
\subsection*{Public Member Functions}
\begin{DoxyCompactItemize}
\item 
\hyperlink{classmdt_device_scpi_a44c03151a6796e5c1efd64ef55f2d14d}{mdtDeviceScpi} (QObject $\ast$parent=0)
\begin{DoxyCompactList}\small\item\em Construct a SCPI device. \end{DoxyCompactList}\item 
\hypertarget{classmdt_device_scpi_a7dc5ab8856a766a45bcc7e9cba0f54ca}{
\hyperlink{classmdt_port_manager}{mdtPortManager} $\ast$ \hyperlink{classmdt_device_scpi_a7dc5ab8856a766a45bcc7e9cba0f54ca}{portManager} ()}
\label{classmdt_device_scpi_a7dc5ab8856a766a45bcc7e9cba0f54ca}

\begin{DoxyCompactList}\small\item\em Get internal port manager instance. \end{DoxyCompactList}\item 
\hyperlink{classmdt_abstract_port_ad4121bb930c95887e77f8bafa065a85e}{mdtAbstractPort::error\_\-t} \hyperlink{classmdt_device_scpi_ae8e886b362cbf9d1bf7064b48348b8e8}{connectToDevice} (const \hyperlink{classmdt_device_info}{mdtDeviceInfo} \&devInfo)
\begin{DoxyCompactList}\small\item\em Search and connect to physical device. \end{DoxyCompactList}\item 
int \hyperlink{classmdt_device_scpi_ad98f24870f597c31d8788ab4f5bc53fc}{sendCommand} (const QByteArray \&command)
\begin{DoxyCompactList}\small\item\em Send a command to device. \end{DoxyCompactList}\item 
QByteArray \hyperlink{classmdt_device_scpi_a96df8073c8838cc819bf38ed330b076b}{sendQuery} (const QByteArray \&query)
\begin{DoxyCompactList}\small\item\em Send a query to device. \end{DoxyCompactList}\item 
bool \hyperlink{classmdt_device_scpi_aefd45e58d01aed9a165bb2c2dd98198c}{waitOperationComplete} (int timeout, int interval)
\begin{DoxyCompactList}\small\item\em Wait until operation is complete (Using $\ast$OPC? query) \end{DoxyCompactList}\item 
int \hyperlink{classmdt_device_scpi_a65c6f747ac6c6fe727a7359f78139168}{checkDeviceError} ()
\begin{DoxyCompactList}\small\item\em Query device about error. \end{DoxyCompactList}\end{DoxyCompactItemize}
\subsection*{Protected Member Functions}
\begin{DoxyCompactItemize}
\item 
void \hyperlink{classmdt_device_scpi_a16b6b0c77b1078da285f9d8d9ba52181}{handleDeviceError} (const QList$<$ QVariant $>$ \&decodedValues)
\begin{DoxyCompactList}\small\item\em Handle device error. \end{DoxyCompactList}\item 
virtual void \hyperlink{classmdt_device_scpi_af1cc7d9c99832fa3a7b3c5764588c637}{handleDeviceSpecificError} (int errNum, const QString \&errText, const QList$<$ QString $>$ \&deviceSpecificTexts)
\begin{DoxyCompactList}\small\item\em Handle device's specific error. \end{DoxyCompactList}\item 
void \hyperlink{classmdt_device_scpi_a00d25c16acb20c909210bc5278f713fa}{logDeviceError} (int errNum, const QString \&errText, const QList$<$ QString $>$ \&deviceSpecificTexts, \hyperlink{classmdt_error_a5c8b1a040e2feaa848f6201d6b6f0cd7}{mdtError::level\_\-t} level)
\begin{DoxyCompactList}\small\item\em Log a device error with \hyperlink{classmdt_error}{mdtError} system. \end{DoxyCompactList}\end{DoxyCompactItemize}
\subsection*{Protected Attributes}
\begin{DoxyCompactItemize}
\item 
\hypertarget{classmdt_device_scpi_a6f7bd859a14eddbaab64f492777c1337}{
\hyperlink{classmdt_usbtmc_port_manager}{mdtUsbtmcPortManager} $\ast$ {\bfseries pvUsbtmcPortManager}}
\label{classmdt_device_scpi_a6f7bd859a14eddbaab64f492777c1337}

\end{DoxyCompactItemize}


\subsection{Detailed Description}
Base class for SCPI based instruments. 

Most of current instruments (Agilent, NI, ...) support SCPI command format.

This class give some common functions requierd to handle such devices.

Currently, only USBTMC port is supported. 

Definition at line 41 of file mdtDeviceScpi.h.



\subsection{Constructor \& Destructor Documentation}
\hypertarget{classmdt_device_scpi_a44c03151a6796e5c1efd64ef55f2d14d}{
\index{mdtDeviceScpi@{mdtDeviceScpi}!mdtDeviceScpi@{mdtDeviceScpi}}
\index{mdtDeviceScpi@{mdtDeviceScpi}!mdtDeviceScpi@{mdtDeviceScpi}}
\subsubsection[{mdtDeviceScpi}]{\setlength{\rightskip}{0pt plus 5cm}mdtDeviceScpi::mdtDeviceScpi (
\begin{DoxyParamCaption}
\item[{QObject $\ast$}]{parent = {\ttfamily 0}}
\end{DoxyParamCaption}
)}}
\label{classmdt_device_scpi_a44c03151a6796e5c1efd64ef55f2d14d}


Construct a SCPI device. 

Will create and configure a USBTMC port manager. 

connect(pvUsbtmcPortManager, SIGNAL(newReadenFrame(mdtPortTransaction)), this, SLOT(decodeReadenFrame(mdtPortTransaction))); connect(pvUsbtmcPortManager, SIGNAL(errorStateChanged(int, const QString\&, const QString\&)), this, SLOT(setStateFromPortError(int, const QString\&, const QString\&))); 



Definition at line 32 of file mdtDeviceScpi.cpp.



\subsection{Member Function Documentation}
\hypertarget{classmdt_device_scpi_a65c6f747ac6c6fe727a7359f78139168}{
\index{mdtDeviceScpi@{mdtDeviceScpi}!checkDeviceError@{checkDeviceError}}
\index{checkDeviceError@{checkDeviceError}!mdtDeviceScpi@{mdtDeviceScpi}}
\subsubsection[{checkDeviceError}]{\setlength{\rightskip}{0pt plus 5cm}int mdtDeviceScpi::checkDeviceError (
\begin{DoxyParamCaption}
{}
\end{DoxyParamCaption}
)}}
\label{classmdt_device_scpi_a65c6f747ac6c6fe727a7359f78139168}


Query device about error. 

\begin{Desc}
\item[\hyperlink{todo__todo000023}{Todo}]Buggy, review !\end{Desc}


Will send the SYST:ERR? and return.

Subclass notes:\par
 The SYST:ERR? query is sent to device. A new transaction is initalized, with type MDT\_\-FC\_\-SCPI\_\-ERR. When subclass receives such transaction type, it should call \hyperlink{classmdt_device_scpi_a16b6b0c77b1078da285f9d8d9ba52181}{handleDeviceError()} without decoding frame.

\begin{DoxyReturn}{Returns}
0 if query could be sent or a error of type \hyperlink{classmdt_abstract_port_ad4121bb930c95887e77f8bafa065a85e}{mdtAbstractPort::error\_\-t} else. Note: returned error is not device's error. 
\end{DoxyReturn}


transaction-\/$>$setType(MDT\_\-FC\_\-SCPI\_\-ERR); 



Definition at line 193 of file mdtDeviceScpi.cpp.

\hypertarget{classmdt_device_scpi_ae8e886b362cbf9d1bf7064b48348b8e8}{
\index{mdtDeviceScpi@{mdtDeviceScpi}!connectToDevice@{connectToDevice}}
\index{connectToDevice@{connectToDevice}!mdtDeviceScpi@{mdtDeviceScpi}}
\subsubsection[{connectToDevice}]{\setlength{\rightskip}{0pt plus 5cm}{\bf mdtAbstractPort::error\_\-t} mdtDeviceScpi::connectToDevice (
\begin{DoxyParamCaption}
\item[{const {\bf mdtDeviceInfo} \&}]{devInfo}
\end{DoxyParamCaption}
)\hspace{0.3cm}{\ttfamily  \mbox{[}virtual\mbox{]}}}}
\label{classmdt_device_scpi_ae8e886b362cbf9d1bf7064b48348b8e8}


Search and connect to physical device. 

Will scan available ports and open the first port that has device attached maching request.


\begin{DoxyParams}{Parameters}
{\em devInfo} & Requested device's informations. \\
\hline
\end{DoxyParams}
\begin{DoxyReturn}{Returns}
A error listed in \hyperlink{classmdt_abstract_port_ad4121bb930c95887e77f8bafa065a85e}{mdtAbstractPort::error\_\-t} (NoError on success) 
\end{DoxyReturn}


\hyperlink{classmdt_device_info}{mdtDeviceInfo} device;

device = devInfo; device.setVendorId(0x0957); device.setProductId(0x4d18);

if(\hyperlink{classmdt_device_scpi_a7dc5ab8856a766a45bcc7e9cba0f54ca}{portManager()}-\/$>$openPort())\{ if(\hyperlink{classmdt_device_scpi_a7dc5ab8856a766a45bcc7e9cba0f54ca}{portManager()}-\/$>$\hyperlink{classmdt_device_a721c5bf2cfa0eef5304333f08da182f7}{start()})\{ retVal = \hyperlink{classmdt_abstract_port_ad4121bb930c95887e77f8bafa065a85eab898bd273effe5cb4ed1a399a2d4baad}{mdtAbstractPort::NoError}; \}else\{ retVal = \hyperlink{classmdt_abstract_port_ad4121bb930c95887e77f8bafa065a85ea6e24e272af4da51c84eef5825c5cd712}{mdtAbstractPort::UnhandledError}; \} \}else\{ retVal = \hyperlink{classmdt_abstract_port_ad4121bb930c95887e77f8bafa065a85ea6e24e272af4da51c84eef5825c5cd712}{mdtAbstractPort::UnhandledError}; \}

\begin{Desc}
\item[\hyperlink{todo__todo000022}{Todo}]Add DeviceNotFound error ? \end{Desc}




Reimplemented from \hyperlink{classmdt_device_abab1b6e45af527880ce469ae318474c0}{mdtDevice}.



Reimplemented in \hyperlink{classmdt_device_d_s_o1000_a_a84431cf929750a8a25d5218893736c72}{mdtDeviceDSO1000A}, and \hyperlink{classmdt_device_u3606_a_acf3b48b13bc179ad4f94b3011b7d607a}{mdtDeviceU3606A}.



Definition at line 68 of file mdtDeviceScpi.cpp.

\hypertarget{classmdt_device_scpi_a16b6b0c77b1078da285f9d8d9ba52181}{
\index{mdtDeviceScpi@{mdtDeviceScpi}!handleDeviceError@{handleDeviceError}}
\index{handleDeviceError@{handleDeviceError}!mdtDeviceScpi@{mdtDeviceScpi}}
\subsubsection[{handleDeviceError}]{\setlength{\rightskip}{0pt plus 5cm}void mdtDeviceScpi::handleDeviceError (
\begin{DoxyParamCaption}
\item[{const QList$<$ QVariant $>$ \&}]{decodedValues}
\end{DoxyParamCaption}
)\hspace{0.3cm}{\ttfamily  \mbox{[}protected\mbox{]}}}}
\label{classmdt_device_scpi_a16b6b0c77b1078da285f9d8d9ba52181}


Handle device error. 

\begin{Desc}
\item[\hyperlink{todo__todo000024}{Todo}]Buggy, review !\end{Desc}


This method is called from subclass's decodeReadenFrame(mdtPortTransaction) method when a frame of type MDT\_\-FC\_\-SCPI\_\-ERR was received.

Errors $<$= 0 are handled directly. If error is $>$ 0, \hyperlink{classmdt_device_scpi_af1cc7d9c99832fa3a7b3c5764588c637}{handleDeviceSpecificError()} is called.

See the SCPI99 standard for more details.


\begin{DoxyParams}{Parameters}
{\em decodedValues} & See \hyperlink{classmdt_frame_codec_scpi_a9e38d8afadc7ff37821620feea6b0899}{mdtFrameCodecScpi::decodeError()}. \\
\hline
\end{DoxyParams}
\begin{DoxyPostcond}{Postcondition}
If internal codec has $<$ 2 values, \hyperlink{classmdt_device_scpi_af1cc7d9c99832fa3a7b3c5764588c637}{handleDeviceSpecificError()} is not called. 
\end{DoxyPostcond}


Definition at line 218 of file mdtDeviceScpi.cpp.

\hypertarget{classmdt_device_scpi_af1cc7d9c99832fa3a7b3c5764588c637}{
\index{mdtDeviceScpi@{mdtDeviceScpi}!handleDeviceSpecificError@{handleDeviceSpecificError}}
\index{handleDeviceSpecificError@{handleDeviceSpecificError}!mdtDeviceScpi@{mdtDeviceScpi}}
\subsubsection[{handleDeviceSpecificError}]{\setlength{\rightskip}{0pt plus 5cm}void mdtDeviceScpi::handleDeviceSpecificError (
\begin{DoxyParamCaption}
\item[{int}]{errNum, }
\item[{const QString \&}]{errText, }
\item[{const QList$<$ QString $>$ \&}]{deviceSpecificTexts}
\end{DoxyParamCaption}
)\hspace{0.3cm}{\ttfamily  \mbox{[}protected, virtual\mbox{]}}}}
\label{classmdt_device_scpi_af1cc7d9c99832fa3a7b3c5764588c637}


Handle device's specific error. 

\begin{Desc}
\item[\hyperlink{todo__todo000025}{Todo}]Buggy, review !\end{Desc}


This method is called from \hyperlink{classmdt_device_scpi_a16b6b0c77b1078da285f9d8d9ba52181}{handleDeviceError()}.

This default implementation simply log the error (with \hyperlink{classmdt_error}{mdtError} system).


\begin{DoxyParams}{Parameters}
{\em errNum} & Error number \\
\hline
{\em errText} & Error message \\
\hline
{\em deviceSpecificTexts} & Device's specific informations \\
\hline
\end{DoxyParams}
\begin{DoxyPrecond}{Precondition}
Internal codec has at least 2 values. 
\end{DoxyPrecond}


Definition at line 268 of file mdtDeviceScpi.cpp.

\hypertarget{classmdt_device_scpi_a00d25c16acb20c909210bc5278f713fa}{
\index{mdtDeviceScpi@{mdtDeviceScpi}!logDeviceError@{logDeviceError}}
\index{logDeviceError@{logDeviceError}!mdtDeviceScpi@{mdtDeviceScpi}}
\subsubsection[{logDeviceError}]{\setlength{\rightskip}{0pt plus 5cm}void mdtDeviceScpi::logDeviceError (
\begin{DoxyParamCaption}
\item[{int}]{errNum, }
\item[{const QString \&}]{errText, }
\item[{const QList$<$ QString $>$ \&}]{deviceSpecificTexts, }
\item[{{\bf mdtError::level\_\-t}}]{level}
\end{DoxyParamCaption}
)\hspace{0.3cm}{\ttfamily  \mbox{[}protected\mbox{]}}}}
\label{classmdt_device_scpi_a00d25c16acb20c909210bc5278f713fa}


Log a device error with \hyperlink{classmdt_error}{mdtError} system. 


\begin{DoxyParams}{Parameters}
{\em errNum} & Error number \\
\hline
{\em errText} & Error message \\
\hline
{\em deviceSpecificTexts} & Device's specific informations \\
\hline
\end{DoxyParams}


Definition at line 275 of file mdtDeviceScpi.cpp.

\hypertarget{classmdt_device_scpi_ad98f24870f597c31d8788ab4f5bc53fc}{
\index{mdtDeviceScpi@{mdtDeviceScpi}!sendCommand@{sendCommand}}
\index{sendCommand@{sendCommand}!mdtDeviceScpi@{mdtDeviceScpi}}
\subsubsection[{sendCommand}]{\setlength{\rightskip}{0pt plus 5cm}int mdtDeviceScpi::sendCommand (
\begin{DoxyParamCaption}
\item[{const QByteArray \&}]{command}
\end{DoxyParamCaption}
)}}
\label{classmdt_device_scpi_ad98f24870f597c31d8788ab4f5bc53fc}


Send a command to device. 

Wait until it's possible to write to device, then send the command.

Note that the wait will not break the GUI's event loop (see mdtPortManager::waitOnWriteReady() for details).

This method will not update internal device state. It's recommended to use \hyperlink{classmdt_device}{mdtDevice} functions if available.


\begin{DoxyParams}{Parameters}
{\em command} & Command to send. \\
\hline
\end{DoxyParams}
\begin{DoxyReturn}{Returns}
bTag on success, or a error $<$ 0 (see mdtUsbtmcPortManager::writeData() for details). 
\end{DoxyReturn}


Definition at line 144 of file mdtDeviceScpi.cpp.

\hypertarget{classmdt_device_scpi_a96df8073c8838cc819bf38ed330b076b}{
\index{mdtDeviceScpi@{mdtDeviceScpi}!sendQuery@{sendQuery}}
\index{sendQuery@{sendQuery}!mdtDeviceScpi@{mdtDeviceScpi}}
\subsubsection[{sendQuery}]{\setlength{\rightskip}{0pt plus 5cm}QByteArray mdtDeviceScpi::sendQuery (
\begin{DoxyParamCaption}
\item[{const QByteArray \&}]{query}
\end{DoxyParamCaption}
)}}
\label{classmdt_device_scpi_a96df8073c8838cc819bf38ed330b076b}


Send a query to device. 

Wait until it's possible to write to device, send the query and wait until a response is available or timeout.

Note that the wait will not break the GUI's event loop.

This method will not update internal device and I/O states. It's recommended to use \hyperlink{classmdt_device}{mdtDevice} functions if available.


\begin{DoxyParams}{Parameters}
{\em query} & Query to send. \\
\hline
\end{DoxyParams}
\begin{DoxyReturn}{Returns}
Result as string (empty string on error) Note that \hyperlink{classmdt_frame_codec_scpi}{mdtFrameCodecScpi} can be helpful to decode returned result. 
\end{DoxyReturn}


Definition at line 149 of file mdtDeviceScpi.cpp.

\hypertarget{classmdt_device_scpi_aefd45e58d01aed9a165bb2c2dd98198c}{
\index{mdtDeviceScpi@{mdtDeviceScpi}!waitOperationComplete@{waitOperationComplete}}
\index{waitOperationComplete@{waitOperationComplete}!mdtDeviceScpi@{mdtDeviceScpi}}
\subsubsection[{waitOperationComplete}]{\setlength{\rightskip}{0pt plus 5cm}bool mdtDeviceScpi::waitOperationComplete (
\begin{DoxyParamCaption}
\item[{int}]{timeout, }
\item[{int}]{interval}
\end{DoxyParamCaption}
)}}
\label{classmdt_device_scpi_aefd45e58d01aed9a165bb2c2dd98198c}


Wait until operation is complete (Using $\ast$OPC? query) 

Currently, this method queries device with $\ast$OPC?.


\begin{DoxyParams}{Parameters}
{\em timeout} & Timeout \mbox{[}ms\mbox{]} \\
\hline
{\em interval} & Interval between 2 $\ast$OPC? query \mbox{[}ms\mbox{]} \\
\hline
\end{DoxyParams}
\begin{DoxyPrecond}{Precondition}
interval $>$ 0 
\end{DoxyPrecond}


int maxIter;

maxIter = timeout / interval; 



Definition at line 154 of file mdtDeviceScpi.cpp.



The documentation for this class was generated from the following files:\begin{DoxyCompactItemize}
\item 
src/mdtdevice/mdtDeviceScpi.h\item 
src/mdtdevice/mdtDeviceScpi.cpp\end{DoxyCompactItemize}
